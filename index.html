<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de PDF de Documentos</title>

  <!-- Ajustes para mobile e PWA -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#0d6efd">
  <link rel="manifest" href="manifest.json">

  <!-- Tesseract.js (OCR no navegador) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- Dados de idioma portugu√™s -->
  <script src="https://cdn.jsdelivr.net/npm/@tesseract.js-data/por@1.0.0/index.min.js"></script>
  <!-- jsPDF (gerar PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>

  <style>
    :root {
      --primary: #0d6efd;
      --primary-dark: #0a58ca;
      --accent: #ffc107;
      --bg-body: #f3f4f6;
      --card-bg: #ffffff;
      --border-color: #d0d7de;
      --text-main: #111827;
      --text-muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at top left, #e0edff 0, #f3f4f6 45%, #eef2ff 100%);
      margin: 0;
      padding: 0;
      color: var(--text-main);
    }

    .container {
      max-width: 1100px;
      margin: 24px auto 32px;
      background: var(--card-bg);
      padding: 20px 18px 22px;
      border-radius: 16px;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.15),
        0 0 0 1px rgba(148, 163, 184, 0.35);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    @media (min-width: 768px) {
      .container {
        padding: 24px 28px 28px;
      }
    }

    .header {
      text-align: center;
      margin-bottom: 18px;
    }

    .logo-container {
      text-align: center;
      margin-bottom: 10px;
    }

    .logo {
      max-width: 180px;
      height: auto;
      object-fit: contain;
      display: inline-block;
      filter: drop-shadow(0 4px 10px rgba(15, 23, 42, 0.25));
    }

    .app-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      margin: 4px 0 6px;
      color: #0f172a;
    }

    .app-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin: 0;
    }

    .badge-mini {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(13, 110, 253, 0.07);
      color: var(--primary-dark);
      margin-bottom: 6px;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--primary);
    }

    .form-row {
      margin-bottom: 12px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
      color: #374151;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    input[type="text"] {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    input[type="text"]:focus {
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(13, 110, 253, 0.25);
    }

    input[type="file"] {
      width: 100%;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s ease;
    }

    .btn-primary span.icon {
      font-size: 15px;
    }

    .btn-primary:disabled {
      background: #9ca3af;
      box-shadow: none;
      cursor: not-allowed;
      opacity: 0.8;
    }

    .btn-primary:hover:enabled {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.45);
    }

    #status {
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-muted);
      white-space: pre-line;
      background: #f3f4ff;
      border-radius: 8px;
      padding: 8px 10px;
      border: 1px dashed rgba(99, 102, 241, 0.4);
    }

    #resultados {
      margin-top: 18px;
      padding-left: 0;
      list-style: none;
      font-size: 14px;
    }

    #resultados li {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid rgba(209, 213, 219, 0.9);
      display: flex;
      gap: 10px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .preview-wrapper {
      flex: 0 0 120px;
      text-align: center;
    }

    .preview-image {
      max-width: 110px;
      max-height: 150px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      object-fit: contain;
      background: #ffffff;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.18);
    }

    .preview-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .doc-info {
      flex: 1 1 220px;
      min-width: 220px;
    }

    .doc-info-row {
      margin-bottom: 6px;
    }

    .doc-info-row span.label {
      font-weight: 600;
      font-size: 12px;
      color: #4b5563;
    }

    .tipo {
      font-weight: 700;
      text-transform: uppercase;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.08);
      color: #1d4ed8;
      display: inline-block;
      margin-left: 4px;
    }

    .tipo-desconhecido {
      background: rgba(107, 114, 128, 0.1);
      color: #374151;
    }

    .tipo-certidao {
      background: rgba(16, 185, 129, 0.12);
      color: #047857;
    }

    .tipo-cnh {
      background: rgba(249, 115, 22, 0.14);
      color: #c2410c;
    }

    a.download-link {
      display: inline-block;
      margin-top: 4px;
      padding: 5px 11px;
      border-radius: 999px;
      background: #10b981;
      color: #fff;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(16, 185, 129, 0.4);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
    }

    a.download-link:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(16, 185, 129, 0.55);
    }

    .nome-arquivo-input {
      width: 100%;
      max-width: 320px;
      padding: 5px 7px;
      border-radius: 7px;
      border: 1px solid #d4d4d8;
      font-size: 12px;
      background: #f9fafb;
      margin-top: 3px;
    }

    .nome-arquivo-input:focus {
      outline: none;
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    .top-bar {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 14px;
    }

    @media (min-width: 640px) {
      .top-bar {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-end;
      }
      .actions-wrapper {
        text-align: right;
      }
    }

    .actions-wrapper {
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-container">
        <!-- Suba um arquivo logo.png no reposit√≥rio -->
        <img src="logo.png" alt="Logo" class="logo">
      </div>
      <div class="badge-mini">
        <span class="badge-dot"></span> Ferramenta interna de documentos
      </div>
      <h1 class="app-title">Gerador de PDF de Documentos</h1>
      <p class="app-subtitle">
        Reconhece RG, CPF, CNH, holerites, comprovantes e certid√µes, gera PDFs renomeados por cliente e tipo.
      </p>
    </div>

    <div class="top-bar">
      <div class="form-row" style="flex:1;">
        <label for="clientName">Nome do cliente (opcional)</label>
        <input id="clientName" type="text" placeholder="Ex.: JOAO_SILVA">
        <div class="hint">Se preencher, o nome entra no in√≠cio do arquivo (ex.: JOAO_SILVA_CNH_01.pdf).</div>
      </div>

      <div class="actions-wrapper">
        <div class="form-row">
          <label for="fileInput">Imagens dos documentos</label>
          <input id="fileInput" type="file" multiple accept="image/*">
          <div class="hint">Selecione fotos ou imagens de RG, CPF, CNH, certid√µes, holerites, comprovantes etc.</div>
        </div>
        <button id="btnProcessar" class="btn-primary" onclick="processarImagens()">
          <span class="icon">üìÑ</span>
          <span>Processar documentos</span>
        </button>
      </div>
    </div>

    <div id="status"></div>
    <ul id="resultados"></ul>
  </div>

  <script>
    const { jsPDF } = window.jspdf;

    function lerArquivoComoDataURL(arquivo) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(arquivo);
      });
    }

    // Detecta tipo de documento incluindo certid√µes e CNH
    function identificarTipoDocumento(texto) {
      const t = (texto || "").toLowerCase();

      const ehRG =
        t.includes("carteira de identidade") ||
        t.includes("registro geral") ||
        /\brg\b/.test(t);

      const ehCPF =
        t.includes("cadastro de pessoas fisicas") ||
        t.includes("cadastro de pessoas f√≠sicas") ||
        /\bcpf\b/.test(t);

      const ehHolerite =
        t.includes("holerite") ||
        t.includes("contracheque") ||
        t.includes("contra cheque") ||
        t.includes("contra-cheque");

      const ehComprovante =
        t.includes("comprovante de resid√™ncia") ||
        t.includes("comprovante de residencia") ||
        t.includes("conta de energia") ||
        t.includes("conta de luz") ||
        t.includes("conta de √°gua") ||
        t.includes("conta de agua") ||
        t.includes("conta de telefone") ||
        t.includes("conta de internet") ||
        t.includes("endere√ßo") ||
        t.includes("endereco");

      const ehCertidaoNascimento =
        t.includes("certid√£o de nascimento") ||
        t.includes("certidao de nascimento") ||
        t.includes("registro de nascimento");

      const ehCertidaoCasamento =
        t.includes("certid√£o de casamento") ||
        t.includes("certidao de casamento") ||
        t.includes("registro de casamento");

      const ehCNH =
        t.includes("carteira nacional de habilita√ß√£o") ||
        t.includes("carteira nacional de habilitacao") ||
        /\bcnh\b/.test(t);

      if (ehRG) return "RG";
      if (ehCPF) return "CPF";
      if (ehHolerite) return "HOLERITE";
      if (ehComprovante) return "COMPROVANTE_RESIDENCIA";
      if (ehCertidaoNascimento) return "CERTIDAO_NASCIMENTO";
      if (ehCertidaoCasamento) return "CERTIDAO_CASAMENTO";
      if (ehCNH) return "CNH";
      return "DESCONHECIDO";
    }

    async function processarImagens() {
      const input = document.getElementById("fileInput");
      const statusEl = document.getElementById("status");
      const resultadosEl = document.getElementById("resultados");
      const btn = document.getElementById("btnProcessar");
      const clientNameInput = document.getElementById("clientName");

      const arquivos = input.files;
      if (!arquivos || arquivos.length === 0) {
        alert("Selecione pelo menos uma imagem.");
        return;
      }

      const nomeClienteBase = (clientNameInput.value || "").trim();

      resultadosEl.innerHTML = "";
      statusEl.textContent = "Iniciando processamento...\nIsso pode levar alguns segundos por imagem.";
      btn.disabled = true;

      const contadorPorTipo = {};

      for (let i = 0; i < arquivos.length; i++) {
        const arquivo = arquivos[i];
        statusEl.textContent += `\nProcessando: ${arquivo.name}...`;

        try {
          const dataURL = await lerArquivoComoDataURL(arquivo);

          const resultadoOCR = await Tesseract.recognize(dataURL, "por");
          const texto = resultadoOCR.data.text || "";
          const tipo = identificarTipoDocumento(texto);

          contadorPorTipo[tipo] = (contadorPorTipo[tipo] || 0) + 1;
          const numero = String(contadorPorTipo[tipo]).padStart(2, "0");

          // Sugest√£o de nome: [CLIENTE_]TIPO_XX
          let baseNome = "";
          if (nomeClienteBase) {
            baseNome = removerAcentos(nomeClienteBase.replace(/\s+/g, "_")) + "_";
          }
          baseNome += tipo + "_" + numero;

          // Cria o PDF com a imagem
          const pdf = new jsPDF({
            orientation: "portrait",
            unit: "pt",
            format: "a4"
          });

          const img = new Image();
          img.src = dataURL;
          await new Promise((resolve, reject) => {
            img.onload = () => resolve();
            img.onerror = e => reject(e);
          });

          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const ratio = Math.min(pageWidth / img.width, pageHeight / img.height);
          const imgWidth = img.width * ratio;
          const imgHeight = img.height * ratio;
          const x = (pageWidth - imgWidth) / 2;
          const y = (pageHeight - imgHeight) / 2;

          let formatoImg = "JPEG";
          if (arquivo.type && arquivo.type.includes("png")) {
            formatoImg = "PNG";
          }

          pdf.addImage(img, formatoImg, x, y, imgWidth, imgHeight);

          const blob = pdf.output("blob");
          const url = URL.createObjectURL(blob);

          // Monta o item na lista com pr√©-visualiza√ß√£o + campo pra editar nome
          const li = document.createElement("li");

          const previewDiv = document.createElement("div");
          previewDiv.className = "preview-wrapper";
          const previewImg = document.createElement("img");
          previewImg.src = dataURL;
          previewImg.alt = "Pr√©-visualiza√ß√£o";
          previewImg.className = "preview-image";
          const previewLabel = document.createElement("div");
          previewLabel.className = "preview-label";
          previewLabel.textContent = "Pr√©-visualiza√ß√£o";
          previewDiv.appendChild(previewImg);
          previewDiv.appendChild(previewLabel);

          const infoDiv = document.createElement("div");
          infoDiv.className = "doc-info";

          const linhaOriginal = document.createElement("div");
          linhaOriginal.className = "doc-info-row";
          linhaOriginal.innerHTML = `<span class="label">Arquivo original:</span> ${arquivo.name}`;

          const linhaTipo = document.createElement("div");
          linhaTipo.className = "doc-info-row";
          const spanLabelTipo = document.createElement("span");
          spanLabelTipo.className = "label";
          spanLabelTipo.textContent = "Tipo detectado:";
          const spanTipo = document.createElement("span");
          spanTipo.className = "tipo";
          if (tipo === "DESCONHECIDO") {
            spanTipo.classList.add("tipo-desconhecido");
          } else if (tipo === "CERTIDAO_NASCIMENTO" || tipo === "CERTIDAO_CASAMENTO") {
            spanTipo.classList.add("tipo-certidao");
          } else if (tipo === "CNH") {
            spanTipo.classList.add("tipo-cnh");
          }
          spanTipo.textContent = " " + tipo;
          linhaTipo.appendChild(spanLabelTipo);
          linhaTipo.appendChild(spanTipo);

          const linhaNome = document.createElement("div");
          linhaNome.className = "doc-info-row";
          const labelNome = document.createElement("span");
          labelNome.className = "label";
          labelNome.textContent = "Nome do PDF:";
          const inputNome = document.createElement("input");
          inputNome.type = "text";
          inputNome.className = "nome-arquivo-input";
          inputNome.value = baseNome; // sem .pdf
          inputNome.title = "Edite se quiser alterar o nome do arquivo";

          linhaNome.appendChild(labelNome);
          linhaNome.appendChild(document.createElement("br"));
          linhaNome.appendChild(inputNome);

          const linhaDownload = document.createElement("div");
          linhaDownload.className = "doc-info-row";
          const link = document.createElement("a");
          link.href = url;
          link.className = "download-link";
          link.textContent = "Baixar PDF";

          const atualizarDownloadName = () => {
            let nomeBase = inputNome.value.trim();
            if (!nomeBase) {
              nomeBase = "documento";
            }
            nomeBase = nomeBase.replace(/[\\/:*?"<>|]+/g, "_");
            link.download = nomeBase + ".pdf";
          };

          atualizarDownloadName();
          inputNome.addEventListener("input", atualizarDownloadName);

          linhaDownload.appendChild(link);

          infoDiv.appendChild(linhaOriginal);
          infoDiv.appendChild(linhaTipo);
          infoDiv.appendChild(linhaNome);
          infoDiv.appendChild(linhaDownload);

          li.appendChild(previewDiv);
          li.appendChild(infoDiv);

          resultadosEl.appendChild(li);

        } catch (erro) {
          console.error(erro);
          const li = document.createElement("li");
          li.innerHTML = `
            <div><strong>Arquivo:</strong> ${arquivo.name}</div>
            <div style="color:#c00;"><strong>Erro:</strong> ${erro.message || erro}</div>
          `;
          resultadosEl.appendChild(li);
        }
      }

      statusEl.textContent += `\n\nConclu√≠do! Revise os nomes e clique em ‚ÄúBaixar PDF‚Äù em cada documento.`;
      btn.disabled = false;
    }

    function removerAcentos(str) {
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // Registrar service worker (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('service-worker.js')
          .catch(err => console.log('Erro ao registrar service worker', err));
      });
    }
  </script>
</body>
</html>
